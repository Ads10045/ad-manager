<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Banner Studio Test (Type B - 300x250)</title>
    <!-- jQuery requis pour le script généré -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <style>
        body { background: #f0f0f0; font-family: sans-serif; padding: 20px; text-align: center; }
        .intro { margin-bottom: 20px; color: #555; }
        
        /* Containers to hold the banner */
        #ads-ai-banner-container-1 { margin: 20px auto; border: 1px dashed #ccc; display: inline-block; padding: 10px; background: white; }
    </style>
</head>
<body>

    <h1>Generated Banner Test</h1>
    <p class="intro">This page simulates the exact code generated by the Banner Studio, configured to fetch a <strong>Random Promo Product</strong> from the Production API.</p>

    <div id="ads-ai-banner-container-1">
        <!-- 
            PASTE GENERATED CODE HERE 
            (Simulated below based on ExportPanel logic)
        -->
        
        <!-- Ads-AI Dynamic Banner Integration -->
        <!-- Template: Rectangle (300x250) -->
        <div id="ads-ai-banner" data-product-id="random-promo"></div>

        <script>
        (function($) {
            'use strict';
            
            // Configuration validated from "ExportPanel.jsx" default + user selection
            const CONFIG = {
                apiUrl: 'https://ad-manager-api.vercel.app',  // Vercel Prod
                templateFile: 'rectangle/BannerTypeB-300x250.html', // Fixed template path
                templateSize: '300x250',
                mapping: {
                    // Standard implicit mapping
                    "product1Name": "name",
                    "product1Price": "price",
                    "product1Image": "imageUrl",
                    "product1Url": "sourceUrl",
                    "product1Category": "category"
                },
                affiliationTags: {
                    amazon: {
                        fr: 'nutriplusap-21',
                        es: 'nutriplusap07-21',
                        de: 'nutriplusap0f-21',
                        uk: 'nutriplusa0c7-21',
                        it: 'nutriplusap0e-21',
                        us: 'nutriplusapp2-21'
                    }
                }
            };
            
            function applyAffiliation(url) {
                if (!url || url === '#') return url;
                try {
                    const urlObj = new URL(url);
                    if (urlObj.hostname.includes('amazon')) {
                        let tag = CONFIG.affiliationTags.amazon.us;
                        if (urlObj.hostname.includes('.fr')) tag = CONFIG.affiliationTags.amazon.fr;
                        else if (urlObj.hostname.includes('.es')) tag = CONFIG.affiliationTags.amazon.es;
                        else if (urlObj.hostname.includes('.de')) tag = CONFIG.affiliationTags.amazon.de;
                        else if (urlObj.hostname.includes('.co.uk')) tag = CONFIG.affiliationTags.amazon.uk;
                        else if (urlObj.hostname.includes('.it')) tag = CONFIG.affiliationTags.amazon.it;
                        urlObj.searchParams.set('tag', tag);
                    }
                    return urlObj.toString();
                } catch (e) {
                    return url;
                }
            }
            
            $(document).ready(function() {
                const $container = $('#ads-ai-banner');
                const productId = $container.data('product-id');
                
                if (!productId) return;
                
                // 1. Fetch Product (Random Promo or Specific ID)
                $.ajax({
                    url: CONFIG.apiUrl + '/api/products/' + productId, // /api/products/random-promo
                    method: 'GET',
                    success: function(product) {
                        console.log("Product fetched:", product);
                        
                        // 2. Fetch Template HTML
                        $.ajax({
                            url: CONFIG.apiUrl + '/api/banners/template/' + CONFIG.templateFile,
                            method: 'GET',
                            success: function(html) {
                                console.log("Template fetched");
                                let renderedHtml = html;
                                
                                // 3. Smart placeholders replacement (Logic from ExportPanel)
                                
                                // A. Direct field replacements [name], [price], etc.
                                Object.entries(product).forEach(function([key, value]) {
                                    if (key === 'sourceUrl') value = applyAffiliation(value);
                                    if (key === 'price') value = parseFloat(value).toFixed(2); // Format price
                                    
                                    const regex = new RegExp('\\\\[' + key + '\\\\]', 'gi');
                                    renderedHtml = renderedHtml.replace(regex, value);
                                });

                                // B. Mapped replacements (if any specific mapping exists)
                                // Standard Fallbacks for "product1X" which might be in some older templates
                                if (product.name) renderedHtml = renderedHtml.replace(/\[product1Name\]/gi, product.name);
                                if (product.price) renderedHtml = renderedHtml.replace(/\[product1Price\]/gi, product.price);
                                if (product.imageUrl) renderedHtml = renderedHtml.replace(/\[product1Image\]/gi, product.imageUrl);
                                
                                // Inject
                                $container.html(renderedHtml);
                            },
                            error: function(xhr) {
                                console.error('Failed to load template:', xhr);
                                $container.html('<div style="color:red; p:10px">Error loading template: ' + xhr.status + '</div>');
                            }
                        });
                    },
                    error: function(xhr) {
                        console.error('Failed to fetch product:', xhr);
                        $container.html('<div style="color:red; p:10px">Error loading product: ' + xhr.status + '</div>');
                    }
                });
            });
        })(jQuery);
        </script>
        
        <style>
        #ads-ai-banner {
            display: inline-block;
            width: 300px;
            height: 250px;
            /* Placeholder style before load */
            background: #eee url('https://cdnjs.cloudflare.com/ajax/libs/galleriffic/2.0.1/css/loader.gif') no-repeat center center;
        }
        </style>
        
        <!-- END GENERATED CODE -->
    </div>

</body>
</html>
